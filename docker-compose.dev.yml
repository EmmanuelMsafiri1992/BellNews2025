# docker-compose.dev.yml
# This file defines the multi-service Docker application for your Windows host (development/testing).
# It includes the main Python web app, the Laravel news app,
# and the Ubuntu configuration service (running in mock mode).

# Docker Compose file format version.
version: '3.8'

services:
  # Auto Time Fix Service - Runs before all other services
  time-fix:
    image: ubuntu:22.04
    container_name: fbellnews-time-fix
    privileged: true
    network_mode: host
    volumes:
      - ./auto-time-fix.sh:/usr/local/bin/auto-time-fix.sh:ro
      - /etc/localtime:/etc/localtime:rw
      - /etc/timezone:/etc/timezone:rw
      - /var/log:/var/log:rw
    command: >
      bash -c "
        apt-get update -qq &&
        apt-get install -y --no-install-recommends ntpdate ntp curl wget ca-certificates tzdata &&
        chmod +x /usr/local/bin/auto-time-fix.sh &&
        /usr/local/bin/auto-time-fix.sh &&
        echo 'Time fix completed, keeping container alive for monitoring' &&
        tail -f /var/log/fbellnews-time-fix.log"
    restart: unless-stopped
  # Main Python Flask web application (bellapp)
  pythonapp:
    build: ./bellapp # Specifies the build context for the Python app
    ports:
      - "5000:5000" # Maps host port 5000 to container port 5000
    restart: always
    container_name: bellapp
    volumes:
      - ./bellapp/logs:/bellapp/logs # Mount logs for persistence
      - ./auto-time-fix.sh:/usr/local/bin/auto-time-fix.sh:ro # Time fix script
    depends_on:
      - time-fix # Ensures time is fixed before starting
      - config_service # Ensures config_service starts before pythonapp
    environment:
      # This points to the config_service container by its service name within the Docker network
      UBUNTU_CONFIG_SERVICE_URL: http://config_service:5002

  # Laravel news application
  laravelapp:
    build: ./newsapp
    environment:
      - VITE_API_BASE_URL=http://pythonapp:5000 # Points to pythonapp service within Docker network
    ports:
      - "8000:8000"
      - "5173:5173"
    restart: always
    container_name: newsapp
    volumes:
      - ./auto-time-fix.sh:/usr/local/bin/auto-time-fix.sh:ro # Time fix script
    depends_on:
      - time-fix # Ensures time is fixed before starting
      - pythonapp

  # Ubuntu Configuration Service (running in Docker Test/Mock Mode)
  config_service:
    build:
      context: .
      dockerfile: Dockerfile_config # Use the new universal Dockerfile
    ports:
      - "5002:5002" # Expose port 5002 for the config service
    restart: always
    container_name: config_service
    volumes:
      # Mount a local directory for config_service logs
      - ./config_service_logs:/var/log
      - ./auto-time-fix.sh:/usr/local/bin/auto-time-fix.sh:ro # Time fix script
    depends_on:
      - time-fix # Ensures time is fixed before starting
    environment:
      # Set this flag to 'true' to enable timedatectl and netplan mocking in ubuntu_config_service.py
      IN_DOCKER_TEST_MODE: "true"
